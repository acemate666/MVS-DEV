# 数据驱动先验：分桶权重表（可落地形态）

本篇描述一种面向工程落地的先验增强方式：

- 不训练端到端大模型
- 维护一个小型、可解释、可回滚的“条件统计表”（prior table）

目标是：

- 收窄 stage1 走廊，降低无 post 点时的大偏差风险
- 降低 $N=1..2$ 时的候选锁错率
- 为 stage2 的正则与校正项提供更合理的先验尺度

---

## 1. 交付物定义

prior table 建议包含三类信息（按优先级）：

1. **候选先验权重**：$\{w_m^0\}_{m=1}^M$
2. 可选：分档概率（便于可视化解释），最终仍映射到 $w_m^0$
3. 可选：校正项先验（例如 $a_{xz}$ 的均值/方差）用于 stage2 的 $\theta_m^0$ 与 $\Lambda$

---

## 2. 分桶（bucket）特征：尽量只依赖 prefit 可得量

推荐的最小特征集：

- 速度档：$|v^-|$（例如 3 档）
- 入射角档：由 $v^-\cdot\hat n$ 与 $|v^-|$ 构造的角度（例如 3 档）
- 触地点区域档：用 $p_b$ 在场地平面分区（例如 6–9 档）

可选增强：场地 ID、球类型、环境元信息（若可获得）。

分桶原则：

- 桶数量必须可控（几十级别），便于在线存储与调参
- 特征必须稳定、可回放复现

---

## 3. 先验权重的统计形式：Dirichlet 计数

对每个桶 $b$，维护 Dirichlet 计数 $\alpha_{b,m}$：

$$
 w_{b,m}^0 = \frac{\alpha_{b,m}}{\sum_j \alpha_{b,j}}
$$

初始化建议：

- $\alpha_{b,m}=\alpha_{init}$（例如 1.0），等价于均匀先验 + 平滑
- 避免任何候选权重变成严格 0（对 $N$ 小时稳定性很关键）

---

## 4. 离线冷启动（推荐标准流程）

当上线新场地/新球况时，先做一轮离线冷启动往往收益更大。

建议流程：

1. 采集一定数量反弹样本（每条尽量包含反弹前稳定窗口 + 反弹后较多点）
2. 离线跑 prior+posterior，得到每样本的**软权重** $\{w_m\}$（不只取 MAP）
3. 样本过滤（必须）：剔除明显坏样本（prefit 无效、残差过大、$t_b$ 贴边等）
4. 对落入桶 $b$ 的样本，按质量权重 $\kappa$ 更新：

$$
 \alpha_{b,m} \leftarrow \alpha_{b,m} + \kappa\,w_m
$$

产物建议版本化输出（包含生成时间、桶定义、候选定义、配置摘要）。

---

## 5. 在线沉淀（谨慎启用 + 安全阀）

在线更新必须非常克制，否则容易被误检/极端样本带偏。

建议默认写入条件：

- $N\ge 3$
- 后验数据项残差足够小（拟合确实好）
- 若启用 $t_b$ 搜索，最优 $t_b$ 不贴边
- 一致性检查通过（例如 $v_y^+$ 不离谱）

更新策略：

- 直接加计数（最直观），或
- 采用慢 EMA（更保守）

工程要求：

- prior table 必须可回滚
- 若监控指标恶化，必须能立刻停止写入（只读模式）

---

## 6. 与主流程的衔接点

- stage1：用桶内 $w_m^0$ 替换均匀权重
- stage2：用桶内 $w_m^0$ 作为 6.2 权重更新的先验 $w_m^0$（见 [`05_stage2_posterior.md`](05_stage2_posterior.md)）
- 低 SNR / 缺帧场景：先验增强往往比增加模型自由度更稳（见 [`07_low_snr_policy.md`](07_low_snr_policy.md)）
