# 观测噪声与权重口径：工程契约与落地方式

本文把“观测噪声”从经验描述收敛为可执行的工程口径，目标是：

- 让 stage2 的加权最小二乘 / MAP 在 $N\le 5$ 下**不把噪声拟合成导数**；
- 在“慢轴 / 缺帧 / 远距退化”场景中优先保护时间基准 $t_b$ 与锚点 $(t_b,p_b,v^-)$；
- 让噪声相关的配置与诊断字段变得可解释、可回放复现。

关联阅读：

- stage2 的后验与权重更新：[`05_stage2_posterior.md`](05_stage2_posterior.md)
- prefit 分段冻结与 gap-freeze：[`03_prefit_and_segmentation.md`](03_prefit_and_segmentation.md)
- 低 SNR 退化策略（可辨识性判别与 mode）：[`07_low_snr_policy.md`](07_low_snr_policy.md)
- 像素域噪声与 2D 协方差口径：[`08_observation_2d.md`](08_observation_2d.md)

---

## 1. 为什么“噪声口径”会变成落点灾难

球世界坐标 $(x,y,z)$ 通常由多相机 + IMU/外参反推得到，噪声随深度/视角/模糊/置信度变化。
当某一轴真实运动很慢（典型是 $v_x$ 小）时，该轴的“信号跨度”会与噪声同阶，从而出现两类工程失效：

1. **导数污染**：$v_x$ 抖动、$a_x$ 发散，本质是“噪声被模型二次项吸收”。
2. **时间基准漂移放大**：噪声通过 prefit 外推与触地求根影响 $(t_b,p_b,v^-)$，使 $\tau=t-t_b$ 系统性偏移，出现“残差看似不大，但落点/拦截点整体漂”的结果。

因此优先级应当是：

1) 稳住 $t_b$（分段契约 + 必要时 $t_b$ 小窗联合估计）；
2) 用合理的 $R/W$ 让噪声按轴进入估计；
3) 在不可辨识轴上减少自由度（见低 SNR 策略）。

---

## 2. 统一噪声口径：$R_i$ 与 $W_i$

对 stage2（或任何 WLS/MAP）而言，噪声口径只需要回答：

- 每个点、每个轴的观测方差是什么？
- 这些方差如何映射到权重？

推荐最小口径（对角近似）：

$$
R_i = \mathrm{diag}(\sigma_{x,i}^2,\sigma_{y,i}^2,\sigma_{z,i}^2),\qquad W_i = R_i^{-1}.
$$

单位约束：

- $\sigma_{u,i}$ 的单位必须是 **米（m）**（与 3D 坐标一致）。
- 若在像素域使用 $\Sigma_{ij}$，其单位必须是 **px$^2$**，且只能在像素域目标函数中使用（见 2D 文档）。

---

## 3. `conf` → $\sigma$ → $W$：最小可落地映射

当每点提供无量纲置信度 `conf_i`（越大越可信）时，推荐用单调缩放构造轴向噪声：

$$
\sigma_{u,i} = \frac{\sigma_{u0}}{\sqrt{\max(conf_i,\ c_{\min})}},\qquad
w_{u,i}=\frac{1}{\sigma_{u,i}^2}.
$$

其中：

- $\sigma_{u0}$：三轴基础噪声尺度（m），来自离线标定或经验先验；
- $c_{\min}$：下限，防止 $1/\sqrt{conf}$ 发散；
- 若 `conf_i` 不可用（None/NaN/Inf），工程上应当**回退为 1**（等价“统一权重”）。

可选增强（仅当你有证据证明其单调有效）：

$$
\sigma_{u,i} = (\sigma_{u0} + k_u|z_i|)\ /\ \sqrt{\max(conf_i,c_{\min})}.
$$

说明：这一项用于表达“远距退化”。若未离线验证其稳定性，宁可不上线该项，避免反向加权导致更糟。

---

## 4. 锚点不确定度的传播：把 $p_b$ 与 $t_b$ 当成噪声源

stage2 的观测模型通常以固定 $p_b,t_b$ 构造 $y_i$（见 [`05_stage2_posterior.md`](05_stage2_posterior.md) 的线性形式）。
当 $p_b,t_b$ 本身是估计量时，应避免把它们的误差“误解释”为 $v^+$ 或 $a_{xz}$：

### 4.1 反弹位置 $p_b$ 的不确定度

若 prefit 能输出 $\mathrm{Cov}(p_b)$（或至少对角尺度 $\sigma_{pb,x/y/z}$），可直接加到每点的观测方差上：

$$
R_i^{total} \leftarrow R_i^{meas} + R^{pb},\qquad R^{pb}=\mathrm{diag}(\sigma_{pb,x}^2,\sigma_{pb,y}^2,\sigma_{pb,z}^2).
$$

这一步的工程含义是：**锚点越不稳，越不应让少量 post 点把导数拉飞来“解释锚点误差”。**

### 4.2 反弹时刻 $t_b$ 的不确定度（时间基准噪声）

$t_b$ 误差会通过 $\tau_i=t_i-t_b$ 影响模型项。可用一阶线性化给出一个可落地的近似：

$$
\sigma_{u,i}^{tb} \approx \big|\dot u(\tau_i)\big|\,\sigma_{t_b},
\qquad
\sigma_{u,i}^{total} \leftarrow \sqrt{(\sigma_{u,i}^{meas})^2 + (\sigma_{u,i}^{tb})^2}.
$$

其中 $\dot u(\tau_i)$ 可用“候选预测/先验速度”近似（因为在 stage2 早期，$N$ 小时不宜从数据反推该导数）。

当 $\sigma_{t_b}$ 很大（缺帧反弹不可见）时，更推荐直接启用 **$t_b$ 小窗联合估计**（见 stage2 增强项），而不是强行靠加大噪声把问题拖过去。

---

## 5. 与低 SNR 退化、鲁棒门控的分工

噪声口径并不替代低 SNR 策略，二者分工如下：

- **噪声口径（本文）**：回答“每点权重多少”。它不改变模型自由度。
- **低 SNR 退化（`07_low_snr_policy.md`）**：回答“该轴是否可辨识”。当不可辨识时，必须减少自由度（冻结 $a$ / 速度强先验 / 忽略该轴）。
- **鲁棒门控**：回答“是否离群/错关联”。例如单点残差门限、两步重加权（IRLS-lite）。

工程顺序建议：先上噪声口径与低 SNR，再考虑更复杂的鲁棒或更强模型。

---

## 6. 最小验证标准（上线门槛）

- 单元/回放验证：在固定回放数据上，`conf` 变小应单调降低该点权重（可打印/记录 $\sigma,w$ 诊断）。
- 慢轴场景：在 $\Delta x$ 很小的数据段，$a_x$ 不应出现量级离谱（应被退化策略冻结或被强先验钉住）。
- 缺帧场景：$t_b$ 不应随新增 post 点大幅漂移；若漂移，必须能通过“小窗联合估计 $t_b$”解释并收敛。
- 文档契约：本文与 `07_low_snr_policy.md` / `05_stage2_posterior.md` 的符号与口径一致（$t_b,p_b,\tau,y_c$）。
