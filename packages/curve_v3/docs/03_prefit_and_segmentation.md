# Prefit 与分段契约：反弹事件锚点 $(t_b,p_b,v^-)$

本篇聚焦一个工程结论：

> 第二段预测的灾难性偏差，常见根因不是“飞行模型不够复杂”，而是**时间基准 $t_b$ 漂移**。

因此，本阶段的目标不是“拟合整段曲线”，而是稳定输出可复现的反弹事件锚点：

- $t_b$：反弹时刻（时间基准）
- $p_b$：反弹位置（球心）
- $v^-$：反弹前速度

并给出最低限度的不确定性尺度（例如残差 RMS 或若干轴向噪声尺度），供后续走廊与后验权重使用。

---

## 1. 为什么 $t_b$ 必须被当成“接口契约”

第二段模型常使用相对时间 $\tau=t-t_b$。当 $t_b$ 被后续点不断“改写”时，$\tau$ 会系统性缩放，从而把本来较小的模型误差放大为落点/拦截点的大偏差。

工程契约建议：

- **prefit 只消费反弹前点**来估计 $(t_b,p_b,v^-)$。
- 一旦进入 post 段（分段触发），应**冻结** prefit 锚点并记录冻结原因。
- 若需要利用 post 点修正 $t_b$，应通过 posterior 的“联合估计 $t_b$（小窗搜索）”产生独立输出 $\hat t_b$，而不是回灌修改 prefit 锚点（见 [`05_stage2_posterior.md`](05_stage2_posterior.md)）。

---

## 2. 触地高度：避免把球心触地当作 $y=0$

相机/定位系统输出通常是**球心**位置。触地条件应写为：

$$
 y(t_b) = y_c = y_{\text{ground}} + r + b_y
$$

其中：

- $r$：球等效半径
- $b_y$：系统性高度偏置（外参/地面平面误差等）

工程约束：$y_c$ 必须是可配置项，且被触地求根、落点定义、以及分段判定一致使用。

---

## 3. 窗口内的最小可落地拟合模型（数值稳定优先）

推荐在短窗口内使用低维、物理一致的局部模型，并做时间归一：

- 选参考时刻 $t_{ref}$（常取窗口末端）
- 定义 $\tau=t-t_{ref}$（窗口内 $\tau\le 0$）

### 3.1 竖直方向（固定重力，避免过拟合）

$$
 y(\tau)=y_0+v_y\tau-\tfrac12 g\tau^2
$$

其中 $g$ 固定不拟合。

### 3.2 水平面（等效常加速度，吸收系统性偏差）

对 $u\in\{x,z\}$：

$$
 u(\tau)=u_0+v_u\tau+\tfrac12 a_u\tau^2
$$

工程建议：水平面二次项不应随意关闭；它往往比“复杂飞行模型”更能稳定 $v^-$ 与外推 $p_b$。

---

## 4. 鲁棒性：最小闭环的两步策略

在真实数据中，离群点/缺帧/误检不可避免。推荐采用一次重加权或剔除的轻量鲁棒策略：

1. 先做一次加权最小二乘（WLS）得到初解。
2. 计算残差并对超阈值点降权/剔除。
3. 再做一次 WLS 得到最终解。

权重来源可用：点级置信度（`conf`）、像素一致性质量分（见 [`08_observation_2d.md`](08_observation_2d.md)）或简单的统一权重。

输出建议包含：

- `prefit_rms`（或每轴 RMS）
- 有效点数
- 是否触发鲁棒剔除

---

## 5. 触地时刻求根与锚点计算

用竖直模型外推求 $\tau_b>0$ 使得 $y(\tau_b)=y_c$：

$$
 y_0+v_y\tau_b-\tfrac12 g\tau_b^2 = y_c
$$

得到 $t_b=t_{ref}+\tau_b$。随后：

- $p_b = [x(\tau_b),\ y(\tau_b),\ z(\tau_b)]^\top$
- $v^- = [\dot x(\tau_b),\ \dot y(\tau_b),\ \dot z(\tau_b)]^\top$

失败与降级（必须显式）：

- 无实根 / 根不为合理正值
- 有效点数不足
- 残差过大

此时应输出 `valid=false`（或 `low_confidence=true` + 原因码），并在 prior 阶段扩大走廊或等待更多点。

---

## 6. 分段契约：避免 post 点污染 prefit

### 6.1 状态机模型

建议把“是否已进入 post 段”实现为可回放复现的二态状态机：

- `PRE_BOUNCE`：只接收反弹前点
- `POST_BOUNCE`：只接收反弹后点

转移只允许单向：`PRE_BOUNCE → POST_BOUNCE`。

### 6.2 触发信号（建议）

- 趋势反转：竖直速度估计从负到正（基于滑窗拟合，不用单帧差分）。
- 近地条件：高度接近 $y_c$（允许容忍 $\epsilon_y$）。
- 去抖/滞回：用时间常数 $T_{down},T_{up}$ 去抖，避免不同 FPS 下行为漂移。

### 6.3 缺帧兜底：visibility-gap freeze

反弹附近常出现时间缺口（不可见帧）。若仍强依赖“近地条件”，容易导致长时间不触发，从而把 post 点混入 prefit。

建议在检测到显著时间缺口后：

- 在缺口左侧末端点上拟合竖直模型
- 粗预测触地时刻 $\hat t_b$
- 若 $\hat t_b$ 落在缺口附近，则直接冻结：切分点取缺口左侧最后一点

该策略的目标是“隔离污染”，不承诺 $\hat t_b$ 精确。

### 6.4 推荐输出的诊断字段

- `t_freeze`：冻结发生时刻
- `freeze_reason`：例如 `vy_flip_and_near_ground`、`visibility_gap_freeze`
- `cut_index` / `cut_time`：切分位置（便于回放复现）

---

## 7. 与后续阶段的接口

- prior 阶段使用 $(t_b,p_b,v^-)$ 生成候选与走廊（见 [`04_stage1_prior.md`](04_stage1_prior.md)）。
- posterior 阶段在固定 $t_b$ 下做少点校正；若 $t_b$ 低置信，可启用小窗联合估计（见 [`05_stage2_posterior.md`](05_stage2_posterior.md)）。
