# 第一阶段（prior）：候选生成与走廊（corridor）

第一阶段在工程上不追求“唯一真值轨迹”，而是输出：

- 名义预测（nominal）
- 少量候选（candidates）
- 走廊（corridor）：用于风险边界与下游决策

其核心动机是：反弹后轨迹强烈受不可观测因素影响（自旋、接触状态、场地/球况），在缺少可靠观测的条件下，多假设覆盖往往比“单曲线精拟合”更稳。

---

## 1. 反弹最小模型：法向恢复 + 切向等效映射

设地面法向为 $\hat n$，反弹前速度分解为法向与切向：

- $v_n^- = (v^-\cdot\hat n)\hat n$
- $v_t^- = v^- - v_n^-$

### 1.1 法向：恢复系数 $e$

$$
 v_n^+ = -e\,v_n^-
$$

### 1.2 切向：$2\times 2$ 等效映射（覆盖方向耦合）

在切平面正交基 $(\hat t_1,\hat t_2)$ 下表示二维切向速度：

$$
 u^- = \begin{bmatrix} v^-\cdot\hat t_1 \\ v^-\cdot\hat t_2 \end{bmatrix},\qquad
 u^+ = \begin{bmatrix} v^+\cdot\hat t_1 \\ v^+\cdot\hat t_2 \end{bmatrix}
$$

采用低参数化形式：各向同性缩放 + 小角度旋转

$$
 u^+ = A u^-,\quad A = k_t R(\phi)
$$

其中

$$
R(\phi)=\begin{bmatrix}
\cos\phi & -\sin\phi\\
\sin\phi & \cos\phi
\end{bmatrix}
$$

该形式的工程含义：

- $k_t$ 吸收切向能量变化
- $\phi$ 吸收切向方向偏转（侧旋/接触耦合的等效表现）

最后把切向速度从 2D 基还原到 3D：

$$
 v_t^+ = u_1^+\hat t_1 + u_2^+\hat t_2,
\qquad v^+ = v_n^+ + v_t^+
$$

---

## 2. 候选离散化：用少量分档覆盖不确定性

把 $(e,k_t,\phi)$ 离散成少量档位（由数据标定或保守经验范围给出）：

- $e\in\{e_{low},e_{mid},e_{high}\}$
- $k_t\in\{k_{low},k_{mid},k_{high}\}$
- $\phi\in\{\phi_{left},0,\phi_{right}\}$（可选；关闭时只取 $\phi=0$）

候选数：

$$
M = |e|\cdot|k_t|\cdot|\phi|
$$

典型取值：

- $M=27$（启用 $\phi$ 三档）
- $M=9$（关闭 $\phi$，更省算力）

候选数 $M$ 是算力与覆盖率之间的核心旋钮。

---

## 3. 第二段飞行主干：仅重力（解析计算）

为控制算力与数值敏感性，建议把第二段飞行主干固定为仅重力解析：

$$
 p(\tau) = p_b + v^{+(m)}\tau + \tfrac12\,\mathbf g\,\tau^2,
\qquad \tau=t-t_b
$$

这里 $\mathbf g=[0,-g,0]^\top$。

工程解释：

- drag/Magnus 往往与时间基准误差、观测噪声、接触状态不确定性强耦合；在线难稳定标定。
- 在 $N\le 5$ 的 few-shot 校正框架下，更稳妥的做法是让 posterior 用低维等效项吸收主要系统偏差（见 [`05_stage2_posterior.md`](05_stage2_posterior.md)）。

---

## 4. 走廊（corridor）：默认优先多峰安全表示

候选集合经常呈多峰（不同 $\phi/k_t$ 分支）。因此不建议默认只输出“单高斯（均值+协方差）”。

### 4.1 表示法 A：分位数/包络（默认推荐）

对每个输出位置（按时间或按平面），直接输出分位数包络，例如 5%/95%。

优点：

- 多峰安全
- 实现简单，工程解释明确

### 4.2 表示法 B：混合分量（可选增强）

输出 top-K 分量（常用 $K=1\sim2$），每个分量包含：

- `weight`
- `mean`
- `cov`

用于多峰风险表达与下游策略。

---

## 5. 推荐默认输出：按拦截平面（plane corridor）

相比密采样的整段轨迹，按平面输出更贴近任务（拦截/落点），也更节省算力。

### 5.1 下降穿越定义（必须写死口径）

当同一平面存在两个交点时，应选择反弹后的**下降穿越**：

- $\tau>0$
- $\dot y(\tau)<0$（仅重力下 $\dot y(\tau)=v_y^+ - g\tau$）

### 5.2 不可达候选的处理

若某候选不穿越目标平面（例如高度不足/飞出边界），建议输出原因码并在汇总时：

- 剔除并重归一化权重，或
- 标记为 `invalid` 并扩大走廊

---

## 6. 与后续阶段的衔接

- 第一阶段输出的候选与权重，是第二阶段的先验（见 [`05_stage2_posterior.md`](05_stage2_posterior.md)）。
- 若启用数据驱动先验，可把 $w_m^0$ 由均匀改为分桶先验（见 [`09_data_driven_prior.md`](09_data_driven_prior.md)）。
