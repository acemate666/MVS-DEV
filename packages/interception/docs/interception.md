单一击球目标点（$x^*, y^*, z^*, t^*$）”的可落地方案，分别覆盖两种信息量：

1）只有 prefit 点（N=0）：只能依赖 Stage1 候选与先验权重，目标是“命中概率最大 + 时间裕度足够 + 不被多峰均值误导”。
2）有 post 点（1≤N）：先做 Stage2 few-shot 校正与权重更新，再把分布压缩成单点；随着分布收敛逐步变得“更准确”。

我会把它写成一套统一流程（N=0/N>0 只是输入不同），你可以直接按此实现。

────────────────────────────────────────
0. 你必须先明确的输出定义与两个关键参数

A. 击球目标点输出（建议）

* 目标点：$(x_*, y_*, z_*, t_*)$（球心在时刻 $t_*$ 穿越高度平面 $y=y_*$ 的位置）
* 诊断量（强烈建议一并输出，便于调参与排障）：

    * crossing_prob（该高度穿越的总权重质量）
    * width_xz（分位数包络宽度）
    * multi_peak_flag（可选）
    * q5/q50/q95 的 $(x,z,t)$（不是给控制器的目标，而是告诉你不确定性多大）

B. 两个“决定单点质量”的关键参数（没有它们你无法把多峰合理压成单点）
1）击球容差半径（或椭圆） $r_{\text{hit}}$
这是“你给一个目标点，球落在它附近多近算命中”的物理容差（由球拍面、控制误差、时序误差等综合决定）。工程上先给一个保守值，例如 0.10–0.20 m（按你系统实际标定）。
2）击球高度范围 $[y_{\min}, y_{\max}]$
例如 0.5–1.2 m（球心高度）。如果你没给范围，你永远只能在固定平面决策，容易在某些工况下失败率变高。

────────────────────────────────────────

1. 共同基础：把候选映射为“击球高度平面穿越样本集”

输入（共同）：

* prefit 输出：$(t_b,\ p_b=[x_b,y_b,z_b])$，以及（可选）$\sigma_{t_b}$、low_confidence 标志
* 候选集合：$m=1..M$
* 候选权重：$w_m$（$N=0$ 用先验 $w_m^0$；$N>0$ 用后验 $w_m$）
* 候选的第二段参数：

    * $N=0$：每个候选只有 $v^{+(m)}$，且 $a_{xz}=0$
    * $N>0$：每个候选有 $\hat v^{+(m)}$（以及可选 $\hat a_{xz}^{(m)}$）

步骤 1：离散采样 K 个击球高度
K 取 5 就够（算力可控、效果稳定）：

$$
y_k = y_{\min} + \frac{k}{K-1}(y_{\max}-y_{\min}), \quad k=0..K-1
$$

步骤 2：对每个高度 $y_k$，对每个候选 $m$ 计算“反弹后下降穿越点”
竖直方向（固定重力）：

$$
y(\tau)=y_b+v_{y,m}\tau-\tfrac12 g\tau^2
$$

解 $y(\tau)=y_k$ 得两根 $\tau_\pm$，必须按“下降穿越契约”选根（避免选到 $\tau=0$ 或上升根）：

* $\tau>\epsilon_\tau$（建议 1e-3s 或按时间戳精度设置）
* $\dot y(\tau)=v_{y,m}-g\tau<0$

无满足条件的根 → 该候选在该高度 invalid。

水平位置（是否启用 $a_{xz}$）：

* 不启用 $a_{xz}$（N=0 默认）：

    $$
    x_{m,k}=x_b+v_{x,m}\tau,\quad z_{m,k}=z_b+v_{z,m}\tau
    $$

* 启用 $a_{xz}$（N>0 推荐）：

    $$
    \begin{aligned}
    x_{m,k} &= x_b+v_{x,m}\tau+\tfrac12 a_{x,m}\tau^2,\\
    z_{m,k} &= z_b+v_{z,m}\tau+\tfrac12 a_{z,m}\tau^2
    \end{aligned}
    $$

  到达时刻：

    $$
    t_{m,k}=t_b+\tau
    $$

得到该高度的样本集：

$$
\mathcal{S}_k = \{(s_{m,k}, t_{m,k}, w_m)\mid m\in \text{valid}\},\quad s_{m,k}=[x_{m,k}, z_{m,k}]
$$

并计算：

* $crossing\_prob_k=\sum_{m\in \text{valid}} w_m$（无条件概率质量）
* 条件权重（用于统计）$\bar w_{m,k}=w_m/crossing\_prob_k$

步骤 3：计算分位数包络（用于“高度选择”和“不确定性诊断”）
对 $\{x_{m,k}\},\{z_{m,k}\},\{t_{m,k}\}$ 做加权分位数（推荐 5/50/95）：

* $(x_{k,5}, x_{k,50}, x_{k,95})$（z、t 同理）
* $width_k = (x_{k,95}-x_{k,5})+(z_{k,95}-z_{k,5})$

到这里为止，corridor（分位数包络）和多峰都已经“在样本里”了；接下来要解决的是：如何把这堆可能多峰的样本压成一个单点。

────────────────────────────────────────

2. 单点目标的核心：用“命中概率最大化”而不是“均值/中位数”

多峰时，均值/坐标中位数很可能落在“两个峰之间的低概率区”，这是最常见的坑。
要得到一个合理单点，你应该利用物理容差 $r_{\text{hit}}$，直接最大化“球落入命中容差圈内的概率质量”。

对某个高度 $y_k$，定义：若你选择目标点为某个候选样本点 $s_{i,k}$，则命中概率（离散近似）：

$$
P_{\text{hit}}(s_{i,k})=\sum_{j\in \text{valid}}\bar w_{j,k}\cdot \mathbf{1}\big(\lVert s_{j,k}-s_{i,k}\rVert\le r_{\text{hit}}\big)
$$

在该高度上，最优单点（离散集合内）：

$$
i_k^*=\arg\max_i P_{\text{hit}}(s_{i,k})
$$

并把对应的时刻取同一个候选的 $t_{i_k^*,k}$，保证位置与时间自洽。

这一步非常关键：它把“多峰/分位数包络”与“单点目标”连接起来了。多峰时你会自然选择落在某个峰内部、且在容差内覆盖权重最多的点；单峰时它退化为选中心点。

实现复杂度是 $O(M^2)$，但 $M=9/27$ 很小，RK 上完全可接受。

────────────────────────────────────────
3. 如何选击球高度 $y_*$：用分位数包络与命中概率共同打分

你不能只在固定高度上选点，因为不同高度会导致：

* 有些高度 crossing_prob 很低（很多候选根本穿不过去）
* 有些高度多峰更严重、走廊更宽
* 有些高度时间裕度更差

因此：先对每个 $y_k$ 求出“该高度的最优单点” $s_k^*=s_{i_k^*,k}$ 以及其命中概率 $P_{\text{hit}}(s_k^*)$，再选高度。

推荐高度打分（可直接落地）：

* 时间裕度用保守分位数（例如 10%）：$\Delta t_k = t_{k,10}-t_{\text{now}}$
* 走廊宽度：$width_k$
* 穿越概率质量：$crossing\_prob_k$
* 命中概率：$P_{\text{hit}}(s_k^*)$

综合打分：

$$
Score(y_k)= P_{\text{hit}}(s_k^*) + \alpha\cdot \mathrm{clip}(\Delta t_k,0,\Delta t_{\max})
-\lambda\cdot width_k
-\mu\cdot (1-crossing\_prob_k)
$$

选：

$$
y_*=\arg\max_k Score(y_k)
$$

然后输出：

$$
(x_*,z_*,t_*)=(s_{k^*}^*,\ t_{i_{k^*}^*,k^*}),\quad y_*=y_{k^*}
$$

默认参数建议（先跑起来再调）：

* 分位数：q = {0.05, 0.50, 0.95}；时间裕度分位数用 0.10（更保守）
* $\alpha$ 先取 0.2–0.5（视你对“多留时间”与“位置更准”的权衡）
* $\lambda$ 先取 1.0（宽度单位是米）
* $\mu$ 先取 1.0（穿越概率质量很关键）

降级条件（必须）：

* 若所有 $y_k$ 的 $crossing\_prob_k$ 都 < 0.4，或者 valid 候选数 < 3：输出 low_confidence，不要强行给“看似精确”的目标点（这时任何单点都基本是在赌）。

────────────────────────────────────────
4. 情况一：只有 prefit 点（N=0）时的完整流程（更“准确”的含义=命中概率更高）

N=0 的差别仅在于：候选参数来自 Stage1，权重来自先验 $w_m^0$，且通常 $a_{xz}=0$。

流程：
1）prefit 给出 $(t_b,p_b,v^-)$（以及可选的 $\sigma_{t_b}$、low_confidence）。
2）Stage1 生成 $M$ 个候选 $((e,k_t,\phi)\Rightarrow v^{+(m)})$，并给出先验权重 $w_m^0$（没有 prior_table 就均匀）。
3）按第 1 节计算每个高度的样本集 $\mathcal{S}_k$（只用 $v^{+(m)}$ 与重力解析）。
4）对每个高度 $y_k$：

* 算 $crossing\_prob_k$、$width_k$、$\Delta t_k$
* 算该高度最优单点 $s_k^*$（命中概率最大化）
5）选 $y_*$，输出 $(x_*,y_*,z_*,t_*)$。
6）若 low_confidence 或降级条件触发：输出 “不击球/等待更多观测/去准备位” 而不是输出一个不可靠单点。

你会发现：N=0 的“多峰”不会被平均掉，而是通过 $P_{\text{hit}}$ 自然选择某个峰内部的代表点；分位数包络用于高度选择与诊断（你会看到某些高度 width 极大、crossing_prob 极低，直接淘汰）。

────────────────────────────────────────
5. 情况二：有 post 点（1≤N）时的完整流程（准确性来自校正+收敛）

N>0 的关键是：你必须先做 Stage2，得到每候选的校正参数 $\hat\theta_m$ 和后验权重 $w_m$，再重复同样的“平面穿越→命中概率最大化→选高度→输出单点”。

步骤：
1）Stage2 更新（每来一个 post 点就增量更新）

* 对每候选 $m$：信息形式 RLS（$5\times 5$ 或 $3\times 3$）更新 $(A_m,b_m)$，解 $\hat\theta_m$
* 计算后验代价 $J_m^{post}$，log-sum-exp 更新权重 $w_m$
* 若 prefit 低置信度/缺帧：启用 5.5 的小窗口 tb 搜索（可选但强烈建议 auto），输出 posterior_tb（不改写 tb0）

2）用 $\hat\theta_m$ 与 $w_m$ 重算每个高度的 $\mathcal{S}_k$

* 若启用了 $a_{xz}$，水平穿越用 $\tfrac12 a\tau^2$ 项，命中点会明显更贴真值
* 权重用后验 $w_m$，多峰会随 $N$ 增大逐步塌缩

3）在每个高度上仍用命中概率最大化选单点 $s_k^*$，再用 Score 选 $y_*$

4）“收敛后切换 MAP”的可选增强（不是必须，但能更贴真值）
当 $w_{\max}=\max_m w_m$ 足够大（例如 ≥0.7）且 $N\ge 3$ 时，多数情况下已经近似单峰；这时你可以直接取 MAP 候选在 $y_*$ 的穿越点作为输出（更“准确”）：

* 未收敛（$N\le 2$ 或 $w_{\max}<0.7$）：继续用命中概率最大化（稳健）
* 收敛：输出 MAP（或输出“命中概率最大化”也行，二者在单峰时几乎一致）

5）迟滞/稳定（必须，否则目标点会抖）

* 只有当新目标的 Score 明显提升，或 $w_{\max}$ 明显上升、width 明显变窄时才更新目标点；否则保持上一帧目标点（尤其 $N=1..2$ 时很重要）。

6. 两个场景下“准确性提升”的来源总结（便于你验收与调参）

N=0（只有 prefit）时，“更准确”来自：

* 不用均值/中位数（避免多峰落在中间的低概率区）
* 用 $r_{\text{hit}}$ 最大化命中概率质量（单点最优）
* 用分位数宽度与 crossing_prob 选择更稳的击球高度

N>0（有 post）时，“更准确”来自：

* Stage2 校正把每个候选的 $v^+$（以及 $a_{xz}$）拉到更贴数据的位置
* 权重 $w_m$ 随 $N$ 塌缩，多峰变单峰，目标点自然收敛
* 收敛后可切到 MAP 输出（更贴真值），但 $N$ 小时仍用命中概率最大化避免早锁错

────────────────────────────────────────
如果你把以下两项给出一个可用的初值，我可以把上面的参数直接“固化成你系统的默认配置表”，并给出一套建议阈值（可以直接上线回放调）：
1）$r_{\text{hit}}$（你认为球拍面/控制误差允许的水平命中容差，单位 m）
2）$[y_{\min},y_{\max}]$（球心可击球高度范围，单位 m）
