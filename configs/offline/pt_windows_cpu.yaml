# 离线 3D 定位配置（Windows/CPU，使用 Ultralytics YOLOv8 .pt）
# 用法示例（任选其一）：
# - uv run python -m tennis3d.apps.offline_localize_from_captures --config configs/offline/pt_windows_cpu.yaml
# - tennis3d-offline --config configs/offline/pt_windows_cpu.yaml

input:
  # captures 目录：要求包含 metadata.jsonl，且其中 frames.file 指向实际图片。
  captures_dir: data/captures_master_slave/tennis_test

  # 标定文件：支持 .json/.yaml/.yml
  calib: data/calibration/example_triple_camera_calib.json

  # 可选：只使用指定相机序列号（serial）参与检测/定位。
  # - 不写或注释掉：默认使用 captures 中出现的全部相机。
  # - 注意：3D 定位至少需要 2 路视角，且 serials 数量必须 >= require_views。
  # serials:
  #   - DA8199303
  #   - DA8199402

detector:
  # 检测器后端：fake|color|rknn|pt
  # Windows 上通常使用 pt（不依赖 rknn 运行时）。
  name: pt

  # 模型路径：detector=pt 时必填（.pt）
  model: data/models/best.pt

  # 置信度阈值：会传给 detector，同时也会作为 pipeline 的 min_score
  min_score: 0.25

  # 至少需要几路相机同时检测到球，才会做三角化输出 3D
  require_views: 2

  # 多球鲁棒定位参数：
  # - 每路相机最多取 topK 个候选参与跨视角匹配（防止组合爆炸）
  max_detections_per_camera: 10

  # - 3D 候选的最大重投影误差阈值（像素），越小越严格、误检越少
  max_reproj_error_px: 10.0

  # - 把 3D 点投影到某相机后，与该相机检测框中心匹配的最大距离（像素）
  max_uv_match_dist_px: 25.0

  # - 3D 去重阈值（米）：不同相机组合可能得到同一球的重复解
  merge_dist_m: 0.08

run:
  # 最多处理多少个 group（0 表示不限）
  max_groups: 0

output:
  # 输出 JSONL 路径（每行一个结果记录）
  out_jsonl: data/tools_output/offline_positions_3d.pt.jsonl

# 可选：轨迹后处理（curve_stage，基于 curve_v3）。
# 启用后会在每条输出记录中增加顶层 `curve` 字段（结构见 docs/architecture-and-dataflow.md）。
#
# curve:
#   enabled: false
#
#   # 多球关联/track 管理
#   track:
#     max_tracks: 4
#     association_dist_m: 0.6
#     max_missed_s: 0.6
#     min_dt_s: 0.000001
#
#   # 走廊输出：在 y=[y_min,y_max] 的多个平面上输出 xz 的统计（均值/协方差 + 过平面时间分布）
#   corridor:
#     y_min: 0.6
#     y_max: 1.6
#     y_step: 0.1
#
#   # 击球拦截点（可选）：从 curve_v3 的 bounce/candidates/post_points 估计一个稳定的击球目标点
#   interception:
#     enabled: false
#     y_min: 0.7
#     y_max: 1.2
#     num_heights: 5
#     r_hit_m: 0.15
#
#   # 点级置信度来源：quality（用 3D 定位质量）或 constant（常量权重）
#   conf:
#     from: quality
#     constant: 1.0
#
#   # 对输入到 curve 的坐标做轻量变换（不修改上游 balls[*].ball_3d_world）
#   transform:
#     y_offset_m: 0.0
#     y_negate: false
#
#   # 观测过滤（默认关闭；需要上游定位输出包含对应诊断字段）
#   obs_filter:
#     min_views: 0
#     min_quality: 0.0
#     max_median_reproj_error_px: null
#     max_ball_3d_std_m: null
#
#   # 轨迹片段（episode）判定（默认关闭）
#   # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
#   episode:
#     enabled: false
#     buffer_s: 0.6
#     min_obs: 5
#
#     start:
#       z_dir: 0
#       min_abs_dz_m: 0.25
#       min_abs_vz_mps: 1.0
#       gravity_mps2: 9.8
#       gravity_tol_mps2: 3.0
#
#     end:
#       stationary_speed_mps: 0.25
#       end_if_stationary_s: 0.35
#       end_after_predicted_land_s: 0.2
#
#     behavior:
#       reset_predictor_on_start: true
#       reset_predictor_on_end: true
#       feed_curve_only_when_active: false
#
#     # 可选：episode 多 track 处置策略（默认关闭）
#     multi_track:
#       lock_single_track: false
