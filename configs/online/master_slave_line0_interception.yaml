# 在线采集 + 3D 定位配置（主从触发：master=Software，slaves=Line0）
# 目标：在 `master_slave_line0.yaml` 基础上启用 curve_stage + interception（击球拦截点）输出。
#
# 用法示例：
# - uv run python -m tennis3d_online --config configs/online/master_slave_line0_interception.yaml

sdk:
  mvimport_dir: ""
  dll_dir: ""

camera:
  serials:
    - DA8199303
    - DA8199402
    - DA8199243
    - DA8199285

  calib: data/calibration/camera_extrinsics_C_T_B.json

  pixel_format: BayerRG8

  roi:
    width: 640
    height: 640
    offset_x: 200
    offset_y: 800

  exposure:
    auto: Off
    time_us: 5000.0
  gain:
    auto: Off
    value: 15.0

  aoi:
    runtime: true
    update_every_groups: 5
    min_move_px: 10
    smooth_alpha: 0.3
    max_step_px: 0
    recenter_after_missed: 15

run:
  group_by: frame_num
  timeout_ms: 1000
  group_timeout_ms: 1000
  max_pending_groups: 16
  max_groups: 0
  max_wait_seconds: 10

  # 可选：实时策略（latest-only）。默认 false（不改变既有行为）。
  latest_only: false

detector:
  name: pt
  model: data/models/best.pt
  pt_device: cuda:0

  crop:
    size: 0
    smooth_alpha: 0.2
    max_step_px: 0
    reset_after_missed: 15

  min_score: 0.1
  require_views: 2

  max_detections_per_camera: 10
  max_reproj_error_px: 5.0
  max_uv_match_dist_px: 25.0
  merge_dist_m: 0.08

output:
  terminal_status_interval_s: 3.0
  terminal_print_mode: all
  terminal_print_interval_s: 0.7
  terminal_timing: true

  out_jsonl_only_when_balls: true
  out_jsonl_flush_every_records: 20
  out_jsonl_flush_interval_s: 0.5

  # 说明：与 master_slave_line0.yaml 区分文件名，避免覆盖。
  out_jsonl: data/tools_output/online_positions_3d.master_slave.interception.jsonl

time:
  sync_mode: dev_timestamp_mapping
  mapping_warmup_groups: 50
  mapping_window_groups: 200
  mapping_update_every_groups: 5
  mapping_min_points: 20
  mapping_hard_outlier_ms: 50.0

trigger:
  trigger_source: Line0
  master_serial: "DA8199303"
  soft_trigger_fps: 20.0

  master_line_out: Line1
  master_line_source: ExposureStartActive
  master_line_mode: Output
  trigger_activation: FallingEdge
  trigger_cache_enable: true

curve:
  enabled: true

  track:
    max_tracks: 4
    association_dist_m: 3.0
    max_missed_s: 60.0
    min_dt_s: 0.000001

  corridor:
    y_min: 0.7
    y_max: 0.8
    y_step: 0.1

  # 击球拦截点输出（interception）
  interception:
    enabled: true
    # 说明：高度范围与步数可按实际击球手/机器人工作空间调整。
    y_min: 0.7
    y_max: 1.2
    num_heights: 5
    r_hit_m: 0.15

  conf:
    from: quality
    constant: 1.0

  transform:
    y_offset_m: 0.0
    y_negate: false

  obs_filter:
    min_views: 0
    min_quality: 0.0
    max_median_reproj_error_px: null
    max_ball_3d_std_m: null

  episode:
    enabled: true
    buffer_s: 0.6
    min_obs: 5

    start:
      z_dir: 0
      min_abs_dz_m: 0.25
      min_abs_vz_mps: 1.0
      gravity_mps2: 9.8
      gravity_tol_mps2: 3.0

    end:
      stationary_speed_mps: 0.25
      end_if_stationary_s: 0.35
      end_after_predicted_land_s: 0.2

    behavior:
      reset_predictor_on_start: true
      reset_predictor_on_end: true
      feed_curve_only_when_active: false

    multi_track:
      lock_single_track: false
