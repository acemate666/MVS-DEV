# 在线采集 + 3D 定位配置（主从触发示例：master=Software，slaves=Line0）
# 适用：你已经在硬件上把 master 的 LineOut（例如 Line1）接到了 slaves 的 LineIn（例如 Line0）。
#
# 说明：该 online 配置主要用于“在线定位与输出 JSONL”。
# - ROI/像素格式等相机参数放在 camera 段。
# - 如果你要做“采集并保存图片用于标定”（例如 save-mode=sdk-bmp/raw），请使用 mvs.apps.quad_capture。
#
# 用法示例：
# - uv run python -m tennis3d_online --config configs/online/master_slave_line0.yaml

sdk:
  # MVS Python 示例绑定目录（MvImport，可选）：
  # - 推荐设置环境变量：MVS_MVIMPORT_DIR=<.../MvImport>
  # - 或在此处填写目录路径（包含 MvCameraControl_class.py 等文件）
  mvimport_dir: ""

  # MVS SDK 动态库目录（可选）：
  # - 推荐设置环境变量：MVS_DLL_DIR=<...>
  # - 或在此处填写目录路径（包含 MvCameraControl.dll）
  dll_dir: ""

camera:
  serials:
    - DA8199303
    - DA8199402
    # - DA8199243
    - DA8199285

  calib: data/calibration/camera_extrinsics_C_T_B.json

  # 可选：像素格式（空表示不设置，沿用相机当前配置）
  pixel_format: BayerRG8
  # pixel_format: BGR8Packed

  # 可选：相机侧 ROI（会传给 SDK；裁剪不是缩放）
  # - width/height 必须同时设置；不设置就删掉/留空。
  roi:
    width: 1980
    height: 1080
    offset_x: 200
    offset_y: 800
  # roi:
  #   width: 640
  #   height: 640
  #   offset_x: 200
  #   offset_y: 800

  # 曝光/增益：默认保持旧行为（关闭 Auto + 固定参数）。
  exposure:
    auto: Off
    time_us: 10000.0
  gain:
    auto: Off
    value: 15.0

  # 可选：相机侧 AOI（运行中动态平移 OffsetX/OffsetY）。
  aoi:
    runtime: false
    update_every_groups: 3
    min_move_px: 10
    smooth_alpha: 0.1
    # 0 表示不限制单步最大移动
    max_step_px: 0
    recenter_after_missed: 15

run:
  # group_by 建议 frame_num；主从触发时相机帧号通常更稳定。
  group_by: frame_num
  timeout_ms: 1000
  group_timeout_ms: 1000
  # 说明：该值越大，系统在“处理速度跟不上触发速度”时越容易积压到多秒级，
  # 进而导致 ready/lag 指标不断增大（处理的都是“几秒前”的旧帧）。
  # 若你追求“输出尽量新鲜”，建议先把该值调小，再结合 soft_trigger_fps 做吞吐匹配。
  max_pending_groups: 1
  max_groups: 0

  # 可选：超过这么久仍拿不到“完整组包”则退出（0 表示不限）。
  max_wait_seconds: 10

  # 可选：实时策略（latest-only）
  # - true：每次只处理“最新完整组”，可能跳组/丢帧，但可抑制 backlog 增长、保持输出新鲜。
  # - false：按顺序处理队列中的每个完整组（默认）。
  latest_only: true

detector:
  # 这里演示 detector=pt（Windows 友好）；你也可以改为 fake/color 做链路验证。
  name: pt
  model: data/models/best.pt

  # detector=pt 时可选：Ultralytics 推理设备。
  # - 默认 cpu（不写该字段时）。
  # - NVIDIA GPU + CUDA 版 torch 环境下，可写 cuda:0（或 0 / cuda）。
  pt_device: cuda:0

  # 软件裁剪（动态 ROI，可选）：在 detector 前裁剪小窗口以提高吞吐。
  # 重要：裁剪坐标系下的 bbox 会自动加回 offset，保证下游仍是“原图像素坐标系”（这里的“原图”指相机输出的 ROI 图像）。
  crop:
    size: 0
    smooth_alpha: 0.1
    max_step_px: 0
    reset_after_missed: 15

  min_score: 0.05
  require_views: 2

  # 多球鲁棒定位参数：
  max_detections_per_camera: 10
  max_reproj_error_px: 15.0
  max_uv_match_dist_px: 25.0
  merge_dist_m: 0.08

output:
  # 终端输出模式：best|all|none
  terminal_status_interval_s: 3.0
  terminal_print_mode: all
  terminal_print_interval_s: 0.7

  # 可选：逐组（每个 loop / record）打印耗时分解（用于在线排障与性能观察）。
  # - true 会比较“吵”，建议配合 terminal_print_mode=none 或 best 使用。
  terminal_timing: false

  # JSONL 写盘策略
  out_jsonl_only_when_balls: true
  out_jsonl_flush_every_records: 20
  out_jsonl_flush_interval_s: 0.5

  # 输出路径（可选；不写则在线模式默认不落盘）
  out_jsonl: data/tools_output/online_positions_3d.master_slave.jsonl

time:
  sync_mode: dev_timestamp_mapping
  # 以下为在线滑窗映射参数（均为默认值）。仅在 sync_mode=dev_timestamp_mapping 时会用到。
  mapping_warmup_groups: 50
  mapping_window_groups: 200
  mapping_update_every_groups: 5
  mapping_min_points: 20
  mapping_hard_outlier_ms: 50.0

trigger:
  # slave 触发源：这里使用 Line0（与 mvs.apps.quad_capture 示例命令一致）
  trigger_source: Line0

  # master 必须在 camera.serials 列表中
  master_serial: "DA8199303"

  # 主从触发模式下只对 master 下发软触发
  # 说明：你当前统计显示 p50 total_ms≈29.6ms 但 mean≈43.7ms（且存在长尾），
  # 30fps（33.3ms 周期）会长期“产出>消费”，导致 ready/backlog 线性增长。
  # 先降到更可持续的帧率验证链路稳定性；若要回到 30fps，需要进一步降低推理/预处理开销或引入丢帧策略。
  soft_trigger_fps: 50.0

  # master-slave 硬件连接设置：
  master_line_out: Line1
  master_line_source: ExposureStartActive
  master_line_mode: Output
  trigger_activation: FallingEdge
  trigger_cache_enable: true

# 可选：轨迹拟合后处理（curve v3）。默认 disabled。
curve:
  enabled: true

  track:
    max_tracks: 10
    association_dist_m: 3.0
    max_missed_s: 120.0
    min_dt_s: 0.000001

  corridor:
    y_min: 0.7
    y_max: 0.8
    y_step: 0.1

  conf:
    from: quality
    constant: 1.0

  transform:
    y_offset_m: 0.0
    y_negate: false

  # 观测过滤（默认关闭；需要上游定位输出包含对应诊断字段）
  obs_filter:
    min_views: 0
    min_quality: 0.0
    max_median_reproj_error_px: null
    max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode:
    enabled: true
    buffer_s: 0.6
    min_obs: 5

    start:
      z_dir: 0
      min_abs_dz_m: 0.25
      min_abs_vz_mps: 1.0
      gravity_mps2: 9.8
      gravity_tol_mps2: 3.0

    end:
      stationary_speed_mps: 0.25
      end_if_stationary_s: 0.35
      end_after_predicted_land_s: 0.2

    behavior:
      reset_predictor_on_start: true
      reset_predictor_on_end: true
      feed_curve_only_when_active: true

    # 可选：episode 多 track 处置策略（默认关闭）
    multi_track:
      lock_single_track: false
