# 在线采集 + 3D 定位配置模板（主从触发：master=Software，slaves=Line0/Line1，全字段）
#
# 适用：
# - 你已经在硬件上把 master 的 LineOut 接到了 slaves 的 LineIn
# - 你希望只对 master 下发软触发，由 master 输出线触发 slave
#
# 用法示例：
# - uv run python -m tennis3d_online --config examples/configs/templates/online_master_slave_template.yaml

sdk:
  # MVS Python 示例绑定目录（MvImport，可选）：
  mvimport_dir: ""

  # MVS SDK 动态库目录（可选）：
  dll_dir: ""

  # 可选：实时策略（latest-only）
  # - true：每次只处理“最新完整组”，可能跳组/丢帧，但可抑制 backlog 增长、保持输出新鲜。
  # - false：按顺序处理队列中的每个完整组（默认）。
  latest_only: false

camera:
  # 注意：serials 的顺序对功能通常不敏感，但建议固定顺序，便于对齐输出与排查问题
  serials:
    - "<MASTER_SERIAL>"  # master
    - "<SLAVE1_SERIAL>"  # slave1
    - "<SLAVE2_SERIAL>"  # slave2
    - "<SLAVE3_SERIAL>"  # slave3

  calib: <PATH_TO_CALIB_JSON_OR_YAML>

  # 可选：相机图像参数（会传给 SDK）。
  # - pixel_format 为空表示不设置（沿用相机当前配置）。
  # - roi.width/roi.height 必须同时设置；不设置就留空或删除。
  #
  # 说明：
  # - 这里的 ROI 是“相机侧裁剪”（改变相机输出的宽高/偏移），不是缩放。
  # - 如果你设置了固定 ROI（启动前一次性设置），在线入口会自动对标定做主点平移，保证像素坐标系一致。
  pixel_format: ""
  # roi:
  #   width: 1920
  #   height: 1080
  #   offset_x: 0
  #   offset_y: 0

  # 可选：曝光/增益（会在 StartGrabbing 前下发到相机）。
  # 默认保持旧行为：关闭 Auto，并设置固定曝光/增益。
  # - 若想完全不干预曝光/增益，可显式设置：
  #   exposure:
  #     auto: ""
  #     time_us: null
  #   gain:
  #     auto: ""
  #     value: null
  exposure:
    auto: Off
    time_us: 10000.0
  gain:
    auto: Off
    value: 12.0

  # 可选：相机侧 AOI（运行中动态平移 OffsetX/OffsetY）。
  #
  # 典型用途：
  # - 先用 roi.width/roi.height 把相机输出裁到一个“足够大、不易丢球”的窗口（降带宽）
  # - 再启用 aoi.runtime ，让窗口跟随球移动（进一步降带宽）
  # - 如需进一步提速，可叠加 detector.crop.size（在 AOI 内二次软件裁剪，降算力）
  #
  # 注意：
  # - 需要机型支持在取流中写 OffsetX/OffsetY；不支持时写入会失败，窗口不会移动。
  # - 启用后不要做一次性的标定主点平移；本仓库会自动处理（aoi.runtime=true 时不会 apply_sensor_roi_to_calibration）。
  # aoi:
  #   runtime: true
  #   update_every_groups: 2
  #   min_move_px: 8
  #   smooth_alpha: 0.3
  #   max_step_px: 160
  #   recenter_after_missed: 30

detector:
  # detector 默认 fake（仅用于链路/冒烟）。真实使用通常改成 pt，并填写 model 路径。
  name: fake
  model: ""

  min_score: 0.25
  require_views: 2

  # 多球鲁棒定位参数：
  max_detections_per_camera: 10
  max_reproj_error_px: 8.0
  max_uv_match_dist_px: 25.0
  merge_dist_m: 0.08

run:
  group_by: frame_num
  timeout_ms: 1000
  group_timeout_ms: 1000
  max_pending_groups: 256
  max_groups: 0

output:
  # 输出 JSONL（可选）。默认值：不写文件。
  # - 置空（""）表示 None
  out_jsonl: ""

  # JSONL 写盘策略（性能相关）
  out_jsonl_only_when_balls: false
  out_jsonl_flush_every_records: 1
  out_jsonl_flush_interval_s: 0.0

  # 终端输出模式：best|all|none
  terminal_print_mode: best

  # Optional：周期性输出“状态心跳”，用于无球阶段确认程序仍在跑。
  # - 0 表示关闭。
  terminal_status_interval_s: 0.0

  # Optional：逐组（每个 loop / record）打印耗时分解。
  # - 默认关闭，避免输出过多影响阅读/吞吐。
  terminal_timing: false

time:
  # 在线时间轴（默认值：frame_host_timestamp）
  sync_mode: dev_timestamp_mapping

  # 以下为在线滑窗映射参数（均为默认值）。仅在 sync_mode=dev_timestamp_mapping 时会用到。
  mapping_warmup_groups: 20
  mapping_window_groups: 200
  mapping_update_every_groups: 5
  mapping_min_points: 20
  mapping_hard_outlier_ms: 50.0

trigger:
  # slave 的触发源：常见为 Line0/Line1（取决于你的接线与相机设置）
  trigger_source: Line0

  # master 必须在 serials 列表中
  master_serial: "<MASTER_SERIAL>"

  # 主从触发模式：只对 master 下发软触发
  soft_trigger_fps: 5.0

  # master 输出线设置：把 master 的软触发事件映射到某一路输出线上
  master_line_out: Line1
  master_line_source: ""
  master_line_mode: Output

  trigger_activation: FallingEdge
  trigger_cache_enable: false

# 可选：轨迹后处理（curve_stage，基于 curve_v3）。默认 disabled。
curve:
  enabled: false

  track:
    max_tracks: 4
    association_dist_m: 0.6
    max_missed_s: 0.6
    min_dt_s: 0.000001

  corridor:
    y_min: 0.6
    y_max: 1.6
    y_step: 0.1

  interception:
    enabled: false
    y_min: 0.7
    y_max: 1.2
    num_heights: 5
    r_hit_m: 0.15

  conf:
    from: quality
    constant: 1.0

  transform:
    y_offset_m: 0.0
    y_negate: false

  # 观测过滤（默认关闭；要求上游定位输出包含对应诊断字段）
  obs_filter:
    min_views: 0
    min_quality: 0.0
    max_median_reproj_error_px: null
    max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode:
    enabled: false
    buffer_s: 0.6
    min_obs: 5

    start:
      z_dir: 0
      min_abs_dz_m: 0.25
      min_abs_vz_mps: 1.0
      gravity_mps2: 9.8
      gravity_tol_mps2: 3.0

    end:
      stationary_speed_mps: 0.25
      end_if_stationary_s: 0.35
      end_after_predicted_land_s: 0.2

    behavior:
      reset_predictor_on_start: true
      reset_predictor_on_end: true
      feed_curve_only_when_active: false

    # 可选：episode 多 track 处置策略（默认关闭）
    multi_track:
      lock_single_track: false
