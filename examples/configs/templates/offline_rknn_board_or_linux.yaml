# 离线 3D 定位配置模板（RKNN .rknn，通常用于 Rockchip 设备或 Linux 工具链）
# 注意：Windows 上一般无法安装/运行 rknn 相关运行时库。

input:
  captures_dir: <PATH_TO_CAPTURES_DIR>
  calib: <PATH_TO_CALIB_JSON_OR_YAML>

detector:
  name: rknn

  # detector=rknn 时必填（.rknn）
  model: <PATH_TO_MODEL_RKNN>

  min_score: 0.25
  require_views: 2

  # 多球鲁棒定位参数：
  max_detections_per_camera: 10
  max_reproj_error_px: 8.0
  max_uv_match_dist_px: 25.0
  merge_dist_m: 0.08

run:
  max_groups: 0

output:
  # 输出 JSONL 路径（每行一个结果记录）。默认值如下：
  out_jsonl: data/tools_output/offline_positions_3d.jsonl

time:
  # 时间轴（默认值：frame_host_timestamp）
  sync_mode: frame_host_timestamp

  # 可选：映射文件路径。
  # - 仅在 sync_mode=dev_timestamp_mapping 时生效
  # - 为空表示使用默认路径：<captures_dir>/time_mapping_dev_to_host_ms.json
  mapping_path: ""

# 可选：轨迹后处理（curve_stage，基于 curve_v3）。默认 disabled。
curve:
  enabled: false

  track:
    max_tracks: 4
    association_dist_m: 0.6
    max_missed_s: 0.6
    min_dt_s: 0.000001

  corridor:
    y_min: 0.6
    y_max: 1.6
    y_step: 0.1

  interception:
    enabled: false
    y_min: 0.7
    y_max: 1.2
    num_heights: 5
    r_hit_m: 0.15

  conf:
    from: quality
    constant: 1.0

  transform:
    y_offset_m: 0.0
    y_negate: false

  # 观测过滤（默认关闭；要求上游定位输出包含对应诊断字段）
  obs_filter:
    min_views: 0
    min_quality: 0.0
    max_median_reproj_error_px: null
    max_ball_3d_std_m: null

  # 轨迹片段（episode）判定（默认关闭）
  # 起始判定固定为：z 方向门控 + y 轴重力一致性（ay≈g）。
  episode:
    enabled: false
    buffer_s: 0.6
    min_obs: 5

    start:
      z_dir: 0
      min_abs_dz_m: 0.25
      min_abs_vz_mps: 1.0
      gravity_mps2: 9.8
      gravity_tol_mps2: 3.0

    end:
      stationary_speed_mps: 0.25
      end_if_stationary_s: 0.35
      end_after_predicted_land_s: 0.2

    behavior:
      reset_predictor_on_start: true
      reset_predictor_on_end: true
      feed_curve_only_when_active: false

    # 可选：episode 多 track 处置策略（默认关闭）
    multi_track:
      lock_single_track: false
